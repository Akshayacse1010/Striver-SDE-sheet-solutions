name: Spaced Repetition Manager
on:
  schedule:
    - cron: '30 3 * * *' # Runs daily at 9:00 AM IST
  workflow_dispatch: # Allows manual triggering

permissions:
  issues: write  # <--- CRITICAL: Gives the bot permission to comment/reopen

jobs:
  manage-reviews:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            const cycles = {
              'cycle:1': 1,
              'cycle:3': 3,
              'cycle:7': 7,
              'cycle:30': 30
            };

            const nextCycle = {
              'cycle:1': 'cycle:3',
              'cycle:3': 'cycle:7',
              'cycle:7': 'cycle:30',
              'cycle:30': 'completed'
            };

            // FIX: Fetch ALL closed issues (up to 100) and filter in the loop
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100
            });

            const now = new Date();

            for (const issue of issues.data) {
              // Skip issues that don't have a cycle label
              const currentLabelObj = issue.labels.find(l => cycles[l.name]);
              if (!currentLabelObj) continue;

              const currentLabel = currentLabelObj.name;
              const daysWait = cycles[currentLabel];
              const closedAt = new Date(issue.closed_at);
              
              // Calculate days passed (Math.ceil ensures "next morning" counts as 1 day)
              const diffTime = Math.abs(now - closedAt);
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

              if (diffDays >= daysWait) {
                const newLabel = nextCycle[currentLabel];
                
                if (newLabel === 'completed') {
                   await github.rest.issues.addLabels({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     issue_number: issue.number,
                     labels: ['mastered']
                   });
                   await github.rest.issues.removeLabel({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     issue_number: issue.number,
                     name: currentLabel
                   });
                } else {
                  // Re-open the issue
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    state: 'open',
                    labels: [newLabel]
                  });
                  
                  // Remove old label
                  await github.rest.issues.removeLabel({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     issue_number: issue.number,
                     name: currentLabel
                   });
                   
                  // COMMENT WITH MENTION
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `ðŸ”” @${issue.user.login} **Spaced Repetition Alert!** \n\nIt has been **${daysWait} days** since you solved this. The algorithm has reopened it for review.\n\n(Promoted: ${currentLabel} â†’ ${newLabel})`
                  });
                }
              }
            }